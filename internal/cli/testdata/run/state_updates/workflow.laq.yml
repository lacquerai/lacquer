version: "1.0"
metadata:
  name: state-updates
  description: Test workflow for state updates and management
  author: lacquer-team

inputs:
  initial_value:
    type: integer
    description: Initial value for calculations
    default: 10
  
  multiplier:
    type: integer
    description: Multiplier value
    default: 3

workflow:
  state:
    counter: 0
    total: 0
    operations: []
    metadata:
      workflow_name: "state-test"

  steps:
    - id: initialize_state
      action: update_state
      updates:
        counter: ${{ inputs.initial_value }}
        total: ${{ inputs.initial_value }}
        operations: "initialized"
        metadata.current_step: "initialize"

    - id: first_calculation
      run: "go run scripts/calculator.go"
      with:
        current_value: ${{ state.counter }}
        multiplier: ${{ inputs.multiplier }}
        operation: "multiply"
      updates:
        counter: ${{ steps.first_calculation.outputs.calculated_value }}
        total: ${{ state.total + steps.first_calculation.outputs.calculated_value }}
        operations: ${{ state.operations + "|" + steps.first_calculation.outputs.operation }}
        metadata.current_step: "first_calculation"
      outputs:
        calculated_value:
          type: integer
          description: The calculated value
        operation:
          type: string
          description: The operation performed

    - id: second_calculation
      run: "go run scripts/calculator.go"
      with:
        current_value: ${{ state.counter }}
        addition: 100
        operation: "add"
      updates:
        counter: ${{ steps.second_calculation.outputs.calculated_value }}
        total: ${{ state.total + steps.second_calculation.outputs.calculated_value }}
        operations: ${{ state.operations + "|" + steps.second_calculation.outputs.operation }}
        metadata.current_step: "second_calculation"
        metadata.final_counter: ${{ steps.second_calculation.outputs.calculated_value }}
      outputs:
        calculated_value:
          type: integer
          description: The calculated value
        operation:
          type: string
          description: The operation performed

    - id: finalize_state
      action: update_state
      updates:
        metadata.total_operations: ${{ length(state.operations) }}
        final_result: ${{ state.counter }}

  outputs:
    final_counter: ${{ state.counter }}
    total_accumulated: ${{ state.total }}
    all_operations: ${{ state.operations }}
    workflow_metadata: ${{ state.metadata }}
    final_state_result: ${{ state.final_result }}