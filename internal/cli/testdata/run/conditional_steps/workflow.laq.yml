version: "1.0"
metadata:
  name: conditional-steps
  description: Test workflow for conditional step execution
  author: lacquer-team

inputs:
  number:
    type: integer
    description: A number to analyze
    default: 42
  
  mode:
    type: string
    description: Processing mode
    default: "full"

agents:
  decision_agent:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0
    system_prompt: You are a helpful assistant that analyzes numbers and makes decisions.

workflow:
  state:
    skip_analysis: false
    analysis_complete: false

  steps:
    - id: check_number
      run: "go run scripts/number_checker.go"
      with:
        number: ${{ inputs.number }}
      outputs:
        is_large:
          type: boolean
          description: Whether the number is large
        category:
          type: string
          description: Category of the number
        should_analyze:
          type: boolean
          description: Whether further analysis is needed

    - id: conditional_skip_check
      run: |
        echo "conditional_skip_check"
      condition: ${{ !steps.check_number.outputs.should_analyze }}
      updates:
        skip_analysis: true

    - id: analyze_large_number
      agent: decision_agent
      skip_if: ${{ !steps.check_number.outputs.is_large }}
      prompt: |
        The number ${{ inputs.number }} is categorized as "${{ steps.check_number.outputs.category }}".
        Please provide an analysis of what makes this a large number and its mathematical properties.
      outputs:
        analysis:
          type: string
          description: Analysis of the large number

    - id: analyze_medium_number
      agent: decision_agent
      condition: ${{ steps.check_number.outputs.category == 'medium' }}
      prompt: |
        The number ${{ inputs.number }} is categorized as "${{ steps.check_number.outputs.category }}".
        Please provide an analysis of this medium-sized number.
      outputs:
        analysis:
          type: string
          description: Analysis of the medium number

    - id: skip_small_number
      run: "go run scripts/skip_message.go"
      skip_if: ${{ steps.check_number.outputs.should_analyze }}
      outputs:
        message:
          type: string
          description: Skip message
        skipped:
          type: boolean
          description: Whether analysis was skipped

    - id: finalize_analysis
      run: |
        echo "finalize_analysis"
      condition: ${{ inputs.mode == 'full' }}
      updates:
        analysis_complete: true
        final_category: ${{ steps.check_number.outputs.category }}

    - id: conditional_summary
      run: "go run scripts/summary_generator.go"
      with:
        category: ${{ steps.check_number.outputs.category }}
        has_large_analysis: ${{ steps.analyze_large_number.outputs.analysis != null }} // must be bool
        has_medium_analysis: ${{ steps.analyze_medium_number.outputs.analysis != null }}
        was_skipped: ${{ steps.skip_small_number.outputs.skipped || true }}
      outputs:
        summary:
          type: string
          description: Summary of what happened
        type:
          type: string
          description: Type of processing that occurred

  outputs:
    number_category: ${{ steps.check_number.outputs.category }}
    analysis_result: ${{ steps.analyze_large_number.outputs.analysis or steps.analyze_medium_number.outputs.analysis or 'No analysis performed' }}
    processing_summary: ${{ steps.conditional_summary.outputs.summary }}
    state_info: ${{ state }}