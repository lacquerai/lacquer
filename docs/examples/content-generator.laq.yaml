# Content Generation Workflow with Tool Integration
# This workflow demonstrates:
# - Tool integration for extended capabilities
# - Multi-step content creation process
# - Quality gates and iterative improvement
# - Error handling and fallback strategies

version: "1.0"
metadata:
  name: content-generator
  description: |
    Creates high-quality content using research tools, multiple drafts,
    and quality checks. Shows tool integration and iterative workflows.
  author: examples@lacquer.ai
  tags:
    - content-creation
    - tools
    - quality-control
  version: 2.0.0

# Configure agents with specialized roles and tools
agents:
  # Research agent with web search capability
  researcher:
    provider: openai
    model: gpt-4
    temperature: 0.2
    system_prompt: |
      You are a thorough researcher who:
      - Finds credible, recent sources
      - Identifies key facts and trends
      - Cross-references information
      - Cites all sources properly
    tools:
      - name: web_search
        script: "python3 ./tools/web_search.py"
        description: "Search the web for current information on any topic"
        parameters:
          type: object
          required: ["query"]
          properties:
            query:
              type: string
              description: "Search query - be specific and use relevant keywords"
            max_results:
              type: integer
              description: "Maximum number of results to return"
              default: 5
  
  # Content writer with style adaptation
  writer:
    provider: anthropic
    model: claude-3-5-sonnet-20241022
    temperature: 0.7
    system_prompt: |
      You are a skilled content writer who:
      - Adapts tone and style to the audience
      - Creates engaging, well-structured content
      - Uses research effectively
      - Follows SEO best practices when requested
    tools:
      - name: grammar_check
        script: "node ./tools/grammar_check.js"
        description: "Check grammar and style issues"
        parameters:
          type: object
          required: ["text"]
          properties:
            text:
              type: string
              description: "Text to check"
            style:
              type: string
              description: "Writing style guide to follow"
              enum: ["formal", "casual", "technical", "marketing"]
  
  # Editor for quality control
  editor:
    provider: openai
    model: gpt-4
    temperature: 0.1
    system_prompt: |
      You are a meticulous editor who:
      - Checks factual accuracy
      - Improves clarity and flow
      - Ensures consistent tone
      - Rates content quality objectively

# Workflow inputs
inputs:
  topic:
    type: string
    description: The topic to write about
    required: true
  
  content_type:
    type: string
    description: Type of content to create
    enum: ["blog_post", "article", "social_media", "email", "technical_doc"]
    default: "blog_post"
  
  target_audience:
    type: string
    description: Primary audience for the content
    default: "general"
  
  word_count:
    type: integer
    description: Target word count
    default: 800
  
  tone:
    type: string
    description: Desired tone of voice
    enum: ["professional", "casual", "friendly", "authoritative", "conversational"]
    default: "professional"
  
  include_seo:
    type: boolean
    description: Whether to optimize for search engines
    default: true
  
  keywords:
    type: array
    description: SEO keywords to include (if applicable)
    default: []

# Main workflow
workflow:
  # Track content creation progress
  state:
    research_complete: false
    draft_version: 0
    quality_score: 0
    sources: []
    revisions_made: []
    final_content: null
  
  steps:
    # Step 1: Research the topic
    - id: research_topic
      agent: researcher
      prompt: |
        Research "${{ inputs.topic }}" for a ${{ inputs.content_type }}.
        Target audience: ${{ inputs.target_audience }}
        
        Find:
        1. Current trends and recent developments
        2. Key statistics and facts
        3. Expert opinions
        4. Common questions/concerns
        ${{ inputs.include_seo ? '5. Search volume and competition for keywords: ' + join(inputs.keywords, ', ') : '' }}
        
        Use web search to find recent, authoritative sources.
      outputs:
        findings:
          type: array
        sources:
          type: array
        key_points:
          type: array
        statistics:
          type: array
      updates:
        research_complete: true
        sources: ${{ steps.research_topic.outputs.sources }}
    
    # Step 2: Create content outline
    - id: create_outline
      agent: writer
      prompt: |
        Create a detailed outline for a ${{ inputs.content_type }} about "${{ inputs.topic }}".
        
        Research findings:
        ${{ join(steps.research_topic.outputs.key_points, '\n') }}
        
        Requirements:
        - Target length: ${{ inputs.word_count }} words
        - Tone: ${{ inputs.tone }}
        - Audience: ${{ inputs.target_audience }}
        ${{ inputs.include_seo ? '- Include keywords: ' + join(inputs.keywords, ', ') : '' }}
        
        Return a structured outline with main sections and key points for each.
      outputs:
        outline:
          type: object
        estimated_sections:
          type: integer
    
    # Step 3: Write first draft
    - id: write_draft
      agent: writer
      prompt: |
        Write a ${{ inputs.content_type }} following this outline:
        ${{ toJSON(steps.create_outline.outputs.outline) }}
        
        Research to incorporate:
        - Key facts: ${{ join(steps.research_topic.outputs.key_points, '; ') }}
        - Statistics: ${{ join(steps.research_topic.outputs.statistics, '; ') }}
        
        Requirements:
        - Length: ${{ inputs.word_count }} words (Â±10%)
        - Tone: ${{ inputs.tone }}
        - Include citations for facts
        ${{ inputs.include_seo ? '- Naturally include keywords: ' + join(inputs.keywords, ', ') : '' }}
        
        Check grammar and style while writing.
      outputs:
        content:
          type: string
        word_count:
          type: integer
      updates:
        draft_version: 1
    
    # Step 4: Review and score the draft
    - id: review_draft
      agent: editor
      prompt: |
        Review this ${{ inputs.content_type }} draft:
        
        ${{ steps.write_draft.outputs.content }}
        
        Evaluate:
        1. Accuracy of information (check against sources)
        2. Clarity and readability
        3. Engagement and flow
        4. Appropriateness for ${{ inputs.target_audience }}
        5. Achievement of ${{ inputs.tone }} tone
        ${{ inputs.include_seo ? '6. SEO optimization and keyword usage' : '' }}
        
        Provide:
        - quality_score: 0-100
        - strengths: array of strong points
        - improvements: array of needed improvements
        - factual_errors: array of any errors found
      outputs:
        quality_score:
          type: integer
        strengths:
          type: array
        improvements:
          type: array
        factual_errors:
          type: array
      updates:
        quality_score: ${{ steps.review_draft.outputs.quality_score }}
    
    # Step 5: Revise if quality is below threshold
    - id: revise_content
      condition: ${{ steps.review_draft.outputs.quality_score < 80 }}
      agent: writer
      prompt: |
        Revise the content to address these issues:
        
        Improvements needed:
        ${{ join(steps.review_draft.outputs.improvements, '\n') }}
        
        Factual errors to fix:
        ${{ join(steps.review_draft.outputs.factual_errors, '\n') }}
        
        Original content:
        ${{ steps.write_draft.outputs.content }}
        
        Maintain the strengths identified:
        ${{ join(steps.review_draft.outputs.strengths, '\n') }}
        
        Keep the same requirements for length, tone, and audience.
      outputs:
        revised_content:
          type: string
        changes_made:
          type: array
      updates:
        draft_version: 2
        revisions_made: ${{ steps.revise_content.outputs.changes_made }}
    
    # Step 6: Final review of revised content
    - id: final_review
      condition: ${{ steps.review_draft.outputs.quality_score < 80 }}
      agent: editor
      prompt: |
        Final review of revised content:
        
        ${{ steps.revise_content.outputs.revised_content }}
        
        Changes made:
        ${{ join(steps.revise_content.outputs.changes_made, '\n') }}
        
        Confirm all issues have been addressed and provide final quality score.
      outputs:
        final_score:
          type: integer
        ready_to_publish:
          type: boolean
    
    # Step 7: Format final content
    - id: format_content
      agent: writer
      prompt: |
        Format the final content for ${{ inputs.content_type }}:
        
        Content: ${{ steps.review_draft.outputs.quality_score >= 80 ? steps.write_draft.outputs.content : steps.revise_content.outputs.revised_content }}
        
        Add:
        1. Appropriate headings and structure
        2. Meta description (if blog/article)
        3. Social media snippets (if requested)
        4. Source citations in proper format
        5. Call-to-action (if appropriate)
        
        Format as JSON with sections for easy parsing.
      outputs:
        formatted_content:
          type: object
        meta_description:
          type: string
        social_snippets:
          type: object
      updates:
        final_content: ${{ steps.format_content.outputs.formatted_content }}
  
  # Workflow outputs
  outputs:
    # Main content output
    content:
      body: ${{ state.final_content }}
      word_count: ${{ steps.write_draft.outputs.word_count }}
      meta_description: ${{ steps.format_content.outputs.meta_description }}
      social_snippets: ${{ steps.format_content.outputs.social_snippets }}
    
    # Quality metrics
    quality:
      initial_score: ${{ steps.review_draft.outputs.quality_score }}
      final_score: ${{ steps.final_review.outputs.final_score || steps.review_draft.outputs.quality_score }}
      revisions: ${{ state.draft_version }}
      improvements_made: ${{ state.revisions_made }}
    
    # Research data
    research:
      sources: ${{ state.sources }}
      key_findings: ${{ steps.research_topic.outputs.key_points }}
      statistics_used: ${{ steps.research_topic.outputs.statistics }}
    
    # Process metadata
    metadata:
      topic: ${{ inputs.topic }}
      type: ${{ inputs.content_type }}
      audience: ${{ inputs.target_audience }}
      tone: ${{ inputs.tone }}
      seo_optimized: ${{ inputs.include_seo }}
      keywords_used: ${{ inputs.keywords }}
