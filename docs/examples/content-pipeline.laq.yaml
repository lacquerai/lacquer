# Complete content creation pipeline using blocks and complex control flow
version: "1.0"
metadata:
  name: content-pipeline
  description: End-to-end content creation workflow using reusable blocks
  author: lacquer-team
  tags:
    - content-creation
    - blocks
    - pipeline
    - seo

agents:
  coordinator:
    uses: lacquer/coordinator@v1
    with:
      model: gpt-4
      temperature: 0.5
      focus: content-strategy
  
  editor:
    model: gpt-4
    temperature: 0.3
    system_prompt: |
      You are a professional editor who:
      - Ensures content quality and consistency
      - Checks for grammar and style
      - Maintains brand voice
      - Optimizes for readability

workflow:
  inputs:
    topic:
      type: string
      description: Main topic for content creation
      required: true
    
    content_type:
      type: string
      description: Type of content to create
      enum: ["blog-post", "article", "social-media", "newsletter", "whitepaper"]
      default: "blog-post"
    
    target_audience:
      type: string
      description: Primary target audience
      required: true
    
    keywords:
      type: array
      description: SEO keywords to target
      default: []
    
    brand_guidelines:
      type: object
      description: Brand voice and style guidelines
      default:
        voice: "professional"
        tone: "informative"
        style: "conversational"
    
    distribution_channels:
      type: array
      description: Where content will be published
      default: ["website", "social-media"]

  state:
    content_iterations: 0
    quality_score: 0
    seo_score: 0
    approval_status: "pending"

  steps:
    # Step 1: Research phase using research block
    - id: comprehensive_research
      uses: lacquer/deep-research@v1
      with:
        topic: "{{ inputs.topic }}"
        focus_areas:
          - recent trends
          - expert opinions
          - statistics and data
          - competitor analysis
        sources: ["web", "academic", "news", "social"]
        min_sources: 8
        max_age_days: 365
      outputs:
        research_summary: string
        key_findings: array
        expert_quotes: array
        statistics: array
        trending_subtopics: array
    
    # Step 2: Audience analysis using analytics block
    - id: audience_analysis
      uses: lacquer/audience-analyzer@v1
      with:
        target_audience: "{{ inputs.target_audience }}"
        content_type: "{{ inputs.content_type }}"
        research_data: "{{ steps.comprehensive_research.outputs.research_summary }}"
      outputs:
        audience_profile: object
        content_preferences: object
        engagement_factors: array
        optimal_length: integer
        preferred_format: string
    
    # Step 3: Content strategy development
    - id: develop_strategy
      agent: coordinator
      prompt: |
        Develop content strategy based on research and audience analysis:
        
        Topic: {{ inputs.topic }}
        Content Type: {{ inputs.content_type }}
        Target Audience: {{ inputs.target_audience }}
        
        Research Insights:
        {{ steps.comprehensive_research.outputs.key_findings | join('\n- ') }}
        
        Audience Profile:
        {{ steps.audience_analysis.outputs.audience_profile | json }}
        
        Content Preferences:
        {{ steps.audience_analysis.outputs.content_preferences | json }}
        
        Target Keywords: {{ inputs.keywords | join(', ') }}
        
        Create a comprehensive content strategy including:
        1. Content outline and structure
        2. Key messages and angles
        3. Content format recommendations
        4. Distribution strategy
        5. Success metrics
      outputs:
        content_outline: object
        key_messages: array
        recommended_format: string
        distribution_plan: object
        success_metrics: array
    
    # Step 4: Parallel content creation for different sections
    - id: create_content_sections
      parallel:
        for_each: "{{ steps.develop_strategy.outputs.content_outline.sections }}"
        as: section
        max_concurrency: 3
        steps:
          - id: write_section
            uses: lacquer/content-writer@v1
            with:
              section_title: "{{ section.title }}"
              section_brief: "{{ section.brief }}"
              key_points: "{{ section.key_points }}"
              research_data: "{{ steps.comprehensive_research.outputs }}"
              brand_voice: "{{ inputs.brand_guidelines.voice }}"
              target_length: "{{ section.target_words }}"
              seo_keywords: "{{ inputs.keywords }}"
            outputs:
              section_content: string
              word_count: integer
              keywords_used: array
    
    # Step 5: Assemble complete content
    - id: assemble_content
      uses: lacquer/content-assembler@v1
      with:
        content_type: "{{ inputs.content_type }}"
        sections: "{{ steps.create_content_sections.outputs }}"
        outline: "{{ steps.develop_strategy.outputs.content_outline }}"
        brand_guidelines: "{{ inputs.brand_guidelines }}"
        target_audience: "{{ inputs.target_audience }}"
      outputs:
        complete_content: string
        structure_metadata: object
        total_word_count: integer
    
    # Step 6: Quality review and editing
    - id: quality_review
      agent: editor
      prompt: |
        Review and edit this {{ inputs.content_type }} for quality:
        
        Content:
        {{ steps.assemble_content.outputs.complete_content }}
        
        Brand Guidelines:
        Voice: {{ inputs.brand_guidelines.voice }}
        Tone: {{ inputs.brand_guidelines.tone }}
        Style: {{ inputs.brand_guidelines.style }}
        
        Target Audience: {{ inputs.target_audience }}
        
        Check for:
        1. Grammar and spelling
        2. Brand voice consistency
        3. Readability and flow
        4. Factual accuracy
        5. Engagement level
        6. Call-to-action effectiveness
        
        Provide edited content and quality assessment.
      outputs:
        edited_content: string
        quality_assessment: object
        improvements_made: array
        quality_score: float
      
      # Update state with quality score
      on_success:
        - action: update_state
          updates:
            quality_score: "{{ steps.quality_review.outputs.quality_score }}"
    
    # Step 7: SEO optimization (conditional based on content type)
    - id: seo_optimization
      condition: "{{ inputs.content_type in ['blog-post', 'article', 'whitepaper'] }}"
      uses: lacquer/seo-optimizer@v1
      with:
        content: "{{ steps.quality_review.outputs.edited_content }}"
        target_keywords: "{{ inputs.keywords }}"
        content_type: "{{ inputs.content_type }}"
        competitor_analysis: "{{ steps.comprehensive_research.outputs.research_summary }}"
      outputs:
        optimized_content: string
        seo_score: float
        seo_recommendations: array
        meta_title: string
        meta_description: string
        suggested_tags: array
      
      on_success:
        - action: update_state
          updates:
            seo_score: "{{ steps.seo_optimization.outputs.seo_score }}"
    
    # Step 8: Create social media adaptations
    - id: social_media_variants
      condition: "{{ 'social-media' in inputs.distribution_channels }}"
      uses: lacquer/social-media-adapter@v1
      with:
        source_content: "{{ steps.seo_optimization.outputs.optimized_content | default(steps.quality_review.outputs.edited_content) }}"
        platforms: ["twitter", "linkedin", "facebook", "instagram"]
        brand_voice: "{{ inputs.brand_guidelines.voice }}"
        target_audience: "{{ inputs.target_audience }}"
      outputs:
        platform_posts: object
        hashtag_suggestions: object
        posting_schedule: object
    
    # Step 9: Visual content creation
    - id: create_visuals
      uses: lacquer/visual-generator@v1
      with:
        content_summary: "{{ steps.develop_strategy.outputs.key_messages }}"
        content_type: "{{ inputs.content_type }}"
        brand_guidelines: "{{ inputs.brand_guidelines }}"
        target_platforms: "{{ inputs.distribution_channels }}"
      outputs:
        featured_image: object
        social_images: object
        infographic_data: object
        image_metadata: object
    
    # Step 10: Content validation and iteration
    - id: validate_content
      uses: lacquer/content-validator@v1
      with:
        content: "{{ steps.seo_optimization.outputs.optimized_content | default(steps.quality_review.outputs.edited_content) }}"
        quality_score: "{{ state.quality_score }}"
        seo_score: "{{ state.seo_score }}"
        target_metrics: "{{ steps.develop_strategy.outputs.success_metrics }}"
        brand_compliance: "{{ inputs.brand_guidelines }}"
      outputs:
        is_valid: boolean
        validation_score: float
        issues_found: array
        improvement_suggestions: array
    
    # Step 11: Iterative improvement (if needed)
    - id: improve_content
      condition: "{{ not steps.validate_content.outputs.is_valid and state.content_iterations < 2 }}"
      agent: editor
      prompt: |
        Improve content based on validation feedback:
        
        Current Content:
        {{ steps.seo_optimization.outputs.optimized_content | default(steps.quality_review.outputs.edited_content) }}
        
        Issues Found:
        {{ steps.validate_content.outputs.issues_found | join('\n- ') }}
        
        Improvement Suggestions:
        {{ steps.validate_content.outputs.improvement_suggestions | join('\n- ') }}
        
        Current Scores:
        - Quality: {{ state.quality_score }}
        - SEO: {{ state.seo_score }}
        - Validation: {{ steps.validate_content.outputs.validation_score }}
        
        Apply improvements while maintaining content quality and brand voice.
      outputs:
        improved_content: string
        changes_made: array
      
      on_success:
        - action: update_state
          updates:
            content_iterations: "{{ state.content_iterations + 1 }}"
    
    # Step 12: Final approval workflow
    - id: approval_workflow
      switch:
        on: "{{ state.quality_score >= 8.0 and state.seo_score >= 7.0 }}"
        cases:
          true:
            # Auto-approve high-quality content
            agent: coordinator
            prompt: |
              Content meets auto-approval criteria:
              Quality Score: {{ state.quality_score }}
              SEO Score: {{ state.seo_score }}
              
              Generate final approval and publication recommendations.
            outputs:
              approved: boolean
              approval_reason: string
              publication_ready: boolean
          
          default:
            # Require human approval
            action: human_input
            prompt: |
              Content requires human approval:
              
              Quality Score: {{ state.quality_score }}
              SEO Score: {{ state.seo_score }}
              Validation Score: {{ steps.validate_content.outputs.validation_score }}
              
              Content Preview:
              {{ (steps.improve_content.outputs.improved_content | default(steps.seo_optimization.outputs.optimized_content | default(steps.quality_review.outputs.edited_content)))[:500] }}...
              
              Issues Found: {{ steps.validate_content.outputs.issues_found | length }}
              
              Please review and approve or request changes.
            timeout: 2h
            outputs:
              approved: boolean
              feedback: string
      
      on_success:
        - action: update_state
          updates:
            approval_status: "{{ 'approved' if steps.approval_workflow.outputs.approved else 'rejected' }}"
    
    # Step 13: Prepare for distribution
    - id: prepare_distribution
      condition: "{{ state.approval_status == 'approved' }}"
      parallel:
        steps:
          # Prepare for website
          - id: website_package
            condition: "{{ 'website' in inputs.distribution_channels }}"
            uses: lacquer/website-formatter@v1
            with:
              content: "{{ steps.improve_content.outputs.improved_content | default(steps.seo_optimization.outputs.optimized_content | default(steps.quality_review.outputs.edited_content)) }}"
              seo_data: "{{ steps.seo_optimization.outputs | default({}) }}"
              images: "{{ steps.create_visuals.outputs }}"
          
          # Prepare for email
          - id: email_package
            condition: "{{ 'newsletter' in inputs.distribution_channels }}"
            uses: lacquer/email-formatter@v1
            with:
              content: "{{ steps.improve_content.outputs.improved_content | default(steps.quality_review.outputs.edited_content) }}"
              audience: "{{ inputs.target_audience }}"
              brand_guidelines: "{{ inputs.brand_guidelines }}"
    
    # Step 14: Analytics and tracking setup
    - id: setup_analytics
      uses: lacquer/analytics-setup@v1
      with:
        content_id: "{{ metadata.name }}-{{ now() | date }}"
        content_type: "{{ inputs.content_type }}"
        target_metrics: "{{ steps.develop_strategy.outputs.success_metrics }}"
        distribution_channels: "{{ inputs.distribution_channels }}"
        keywords: "{{ inputs.keywords }}"
      outputs:
        tracking_config: object
        analytics_dashboard: string
        performance_kpis: array

  outputs:
    # Final content deliverables
    final_content: |
      {{
        steps.improve_content.outputs.improved_content |
        default(steps.seo_optimization.outputs.optimized_content |
        default(steps.quality_review.outputs.edited_content))
      }}
    
    # Content metadata
    content_metadata:
      word_count: "{{ steps.assemble_content.outputs.total_word_count }}"
      content_type: "{{ inputs.content_type }}"
      target_audience: "{{ inputs.target_audience }}"
      keywords_targeted: "{{ inputs.keywords }}"
      quality_score: "{{ state.quality_score }}"
      seo_score: "{{ state.seo_score }}"
      iterations: "{{ state.content_iterations }}"
      approval_status: "{{ state.approval_status }}"
    
    # SEO package
    seo_package: "{{ steps.seo_optimization.outputs | default({}) }}"
    
    # Social media content
    social_media_content: "{{ steps.social_media_variants.outputs | default({}) }}"
    
    # Visual assets
    visual_assets: "{{ steps.create_visuals.outputs }}"
    
    # Distribution packages
    distribution_ready:
      website: "{{ steps.website_package.outputs | default({}) }}"
      email: "{{ steps.email_package.outputs | default({}) }}"
      social: "{{ steps.social_media_variants.outputs | default({}) }}"
    
    # Analytics and tracking
    analytics_setup: "{{ steps.setup_analytics.outputs }}"
    
    # Content strategy insights
    strategy_insights:
      research_summary: "{{ steps.comprehensive_research.outputs.research_summary }}"
      audience_insights: "{{ steps.audience_analysis.outputs.audience_profile }}"
      content_strategy: "{{ steps.develop_strategy.outputs }}"
      validation_results: "{{ steps.validate_content.outputs }}"
    
    # Performance predictions
    performance_forecast:
      expected_engagement: "{{ steps.audience_analysis.outputs.engagement_factors }}"
      seo_potential: "{{ steps.seo_optimization.outputs.seo_score | default(0) }}"
      distribution_reach: "{{ steps.prepare_distribution.outputs | length }}"
    
    # Project summary
    project_summary:
      topic: "{{ inputs.topic }}"
      content_type: "{{ inputs.content_type }}"
      research_sources: "{{ steps.comprehensive_research.outputs.key_findings | length }}"
      sections_created: "{{ steps.create_content_sections.outputs | length }}"
      quality_iterations: "{{ state.content_iterations }}"
      approval_method: "{{ 'auto' if state.quality_score >= 8.0 and state.seo_score >= 7.0 else 'manual' }}"
      distribution_channels: "{{ inputs.distribution_channels }}"
      total_deliverables: |
        {{
          (1 if steps.website_package.outputs else 0) +
          (1 if steps.email_package.outputs else 0) +
          (steps.social_media_variants.outputs.platform_posts | length if steps.social_media_variants.outputs else 0) +
          (steps.create_visuals.outputs.social_images | length if steps.create_visuals.outputs else 0)
        }}
    
    # Success indicators
    pipeline_success: "{{ state.approval_status == 'approved' }}"
    ready_for_publication: "{{ steps.prepare_distribution.outputs is defined }}"
    
    # Recommendations for future content
    future_recommendations:
      trending_topics: "{{ steps.comprehensive_research.outputs.trending_subtopics }}"
      audience_preferences: "{{ steps.audience_analysis.outputs.content_preferences }}"
      optimization_opportunities: "{{ steps.validate_content.outputs.improvement_suggestions }}"